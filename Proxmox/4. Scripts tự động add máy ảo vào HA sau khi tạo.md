# PH·∫¶N A ‚Äì CHU·∫®N B·ªä
## 1. C√†i jq (b·∫Øt bu·ªôc ƒë·ªÉ parse API)
```yaml
apt update
apt install -y jq
```
jq --version

## 2. Test API l·∫•y VM to√†n cluster (r·∫•t quan tr·ªçng)
```yaml
pvesh get /cluster/resources --type vm --output-format json | jq -r '.[].vmid'
```
N·∫øu b∆∞·ªõc n√†y OK ‚Üí ƒëi ti·∫øp.

# PH·∫¶N B ‚Äì SCRIPT ADD VM V√ÄO HA
## 3. T·∫°o th∆∞ m·ª•c script
```yaml
mkdir -p /root/scripts
```
## 4. T·∫°o file script
```yaml
nano /root/scripts/add_vm_to_ha.sh
```
## 5. C·∫•p quy·ªÅn ch·∫°y
```yaml
chmod +x /root/scripts/add_vm_to_ha.sh
```
## 6. Test ch·∫°y tay (r·∫•t n√™n l√†m 1 l·∫ßn)
```yaml
/root/scripts/add_vm_to_ha.sh
```
Sau ƒë√≥ ki·ªÉm tra:
```yaml
ha-manager status
```
# PH·∫¶N C ‚Äì SYSTEMD TIMER (02:00 S√ÅNG)
## 7. T·∫°o service
```yaml
nano /etc/systemd/system/add-vm-to-ha.service
```

D√°n:
```yaml
[Unit]
Description=Add VM to Proxmox HA

[Service]
Type=oneshot
ExecStart=/root/scripts/add_vm_to_ha.sh
```
## 8. T·∫°o timer (02:00 m·ªói ng√†y)
```yaml
nano /etc/systemd/system/add-vm-to-ha.timer
```

D√°n:
```yaml
[Unit]
Description=Run add VM to HA daily at 02:00

[Timer]
OnCalendar=*-*-* 02:00:00
Persistent=true

[Install]
WantedBy=timers.target
```
## 9. Enable timer
```yaml
systemctl daemon-reload
systemctl enable --now add-vm-to-ha.timer
```
üîç Ki·ªÉm tra timer
```yaml
systemctl list-timers | grep add-vm-to-ha
```
üß™ Test timer ngay (kh√¥ng ƒë·ª£i 2h s√°ng)
```yaml
systemctl start add-vm-to-ha.service
```

Xem log:
```yaml
journalctl -u add-vm-to-ha.service
```

## 10. Scripts trong file "/root/scripts/add_vm_to_ha.sh"

```yaml
#!/bin/bash
set -u

LOCK_FILE="/var/run/add_vm_to_ha.lock"
LOG_TAG="add_vm_to_ha"

echo "=== Bat dau qu√©t m√°y ·∫£o de th√™m v√†o HA ==="

# ---------- KI·ªÇM TRA LOCK ----------
if [ -f "$LOCK_FILE" ]; then
    echo "[$LOG_TAG] Script dang chay. Tho√°t."
    exit 1
fi
touch "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"' EXIT

# ---------- L·∫§Y SNAPSHOT VM ----------
mapfile -t VM_ARRAY < <(
  pvesh get /cluster/resources --type vm --output-format json \
  | jq -c '.[]'
)

# ---------- V√íNG L·∫∂P KI·ªÇM TRA ----------
for vm in "${VM_ARRAY[@]}"; do
    vmid=$(echo "$vm" | jq -r '.vmid')
    node=$(echo "$vm" | jq -r '.node')
    template=$(echo "$vm" | jq -r '.template // 0')

    echo "[$LOG_TAG] Dang kiem tra VM $vmid tren node $node..."

    if [ "$template" = "1" ] || pvesh get /cluster/ha/resources | grep -q "\"vm:$vmid\""; then
        echo "  -> Bo qua (template hoac da co trong HA)"
        continue
    fi

    CONFIG=$(ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=5 root@"$node" "qm config $vmid" 2>/dev/null)

    if [ -z "$CONFIG" ] || echo "$CONFIG" | grep -Eq '^(scsi|virtio|sata|efidisk0|tpmstate0):\s*(local|local-lvm|local-zfs):'; then
        echo "  -> CH·∫∂N: VM dung o dia cuc bo, khong an toan cho HA"
        continue
    fi

    echo "  -> Dang th√™m VM $vmid vao HA..."
    pvesh create /cluster/ha/resources -sid "vm:$vmid" -state started && echo "  -> THANH CONG" || echo "  -> THAT BAI"
done
echo "=== Hoan thanh ==="
```
## C√°c b∆∞·ªõc tri·ªÉn khai
### B∆∞·ªõc 1. S·ª≠a ƒë·ªãnh d·∫°ng v√† c·∫•p quy·ªÅn (B·∫Øt bu·ªôc)
Ch·∫°y 2 l·ªánh sau ƒë·ªÉ ƒë·∫£m b·∫£o file s·∫°ch v√† c√≥ quy·ªÅn th·ª±c thi:
```yaml
# X√≥a k√Ω t·ª± xu·ªëng d√≤ng l·∫° n·∫øu b·∫°n copy t·ª´ Windows
sed -i 's/\r$//' /root/scripts/add_vm_to_ha.sh

# C·∫•p quy·ªÅn th·ª±c thi cho file
chmod +x /root/scripts/add_vm_to_ha.sh
```
### B∆∞·ªõc 2. Ki·ªÉm tra tr·ª±c ti·∫øp (Test tay)
ƒê·ª´ng ch·∫°y service v·ªôi, h√£y ch·∫°y tr·ª±c ti·∫øp script n√†y ƒë·ªÉ xem n√≥ c√≥ b√°o l·ªói g√¨ kh√¥ng:
```yaml
/root/scripts/add_vm_to_ha.sh
```
### B∆∞·ªõc 3. Kh·ªüi ƒë·ªông l·∫°i Service
B√¢y gi·ªù b·∫°n c√≥ th·ªÉ kh·ªüi ƒë·ªông l·∫°i service qua systemd nh∆∞ trong h√¨nh b·∫°n ƒë√£ th·ª≠:
```yaml
systemctl daemon-reload
systemctl start add-vm-to-ha.service
journalctl -u add-vm-to-ha.service -f
```
K·∫øt qu·∫£: c√°c m√°y ·∫£o ƒë√£ t·∫°o t·ª´ tr∆∞·ªõc nh∆∞ng ch∆∞a add tay ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông add

<img width="1919" height="737" alt="image" src="https://github.com/user-attachments/assets/bdfe51f5-8a08-43e9-96f1-836906e71b01" />


