
# Báo cáo triển khai Nextcloud và Keycloak SSO OIDC trên Docker với Nginx Reverse Proxy và HTTPS Let’s Encrypt

Tài liệu này ghi lại đầy đủ các bước đã thực hiện để triển khai Nextcloud và Keycloak chạy bằng Docker, publish ra Internet qua một IP public, gắn domain riêng cho từng dịch vụ, cấu hình Nginx reverse proxy, cấp chứng chỉ HTTPS, và cấu hình đăng nhập SSO cho Nextcloud bằng Keycloak theo chuẩn OpenID Connect.

Môi trường mục tiêu

1. Nextcloud public domain: cloudnkd.km0.vn
2. Keycloak public domain: auth.cloudnkd.km0.vn
3. IP public: 14.224.247.131
4. Nextcloud container lắng nghe HTTP nội bộ qua port publish: 8080 trên host
5. Keycloak container lắng nghe HTTP nội bộ qua port publish: 8090 trên host
6. Nginx cài trên VM và làm reverse proxy cho cả Nextcloud và Keycloak
7. Chứng chỉ HTTPS cấp bằng Let’s Encrypt và certbot cài qua Snap do xung đột package certbot trong apt với phiên bản Python hệ thống
8. Hạ tầng chạy trong Proxmox, VM có IP private và được NAT port từ IP public vào VM

Mục tiêu cuối

1. Truy cập https://cloudnkd.km0.vn vào Nextcloud có HTTPS hợp lệ
2. Truy cập https://auth.cloudnkd.km0.vn vào Keycloak có HTTPS hợp lệ
3. Người dùng đăng nhập Nextcloud bằng nút Login với Keycloak, xác thực tại Keycloak rồi quay lại Nextcloud
4. Tự tạo tài khoản Nextcloud theo tài khoản Keycloak sau lần đăng nhập đầu tiên

Phần 1 Chuẩn bị mạng và DNS

Bước 1 Kiểm tra DNS trỏ đúng IP public

1. Trên một máy bất kỳ có Internet chạy
   ping cloudnkd.km0.vn
   ping auth.cloudnkd.km0.vn
2. Kết quả mong đợi là cả hai domain trả về 14.224.247.131

Bước 2 Cấu hình bản ghi DNS

1. Tạo bản ghi A cho Nextcloud
   Name cloudnkd
   Value 14.224.247.131
2. Tạo bản ghi A cho Keycloak
   Name auth.cloudnkd
   Value 14.224.247.131

Bước 3 NAT port từ Internet vào VM

Vì dịch vụ chạy trong VM private, cần cấu hình port forward hoặc DNAT ở thiết bị giữ IP public.

1. Mở port 80 và 443 từ Internet về VM nơi chạy Nginx
2. Nếu IP public nằm trên modem router
   Forward TCP 80 về VM port 80
   Forward TCP 443 về VM port 443
3. Nếu IP public nằm trên node Proxmox hoặc firewall riêng
   Tạo DNAT tương đương để 80 và 443 đi vào VM
4. Test từ mạng 4G hoặc máy ngoài LAN
   Mở http://cloudnkd.km0.vn và http://auth.cloudnkd.km0.vn
   Nếu timeout nghĩa là NAT inbound chưa đúng
   Nếu vào được nghĩa là inbound đã thông

Lưu ý về hairpin NAT

Một số modem không hỗ trợ hairpin NAT, nên test gọi domain từ chính VM có thể treo dù từ Internet lại truy cập được. Luôn test từ 4G hoặc máy ngoài LAN để kết luận chính xác.

Phần 2 Triển khai Docker containers

Bước 1 Kiểm tra containers đang chạy

1. Chạy
   docker ps
2. Kỳ vọng thấy các container
   nextcloud_app
   nextcloud_db
   keycloak

Bước 2 Nextcloud container

1. Nextcloud được publish ra host port 8080
2. Có thể kiểm tra từ host
   curl http://127.0.0.1:8080

Bước 3 Keycloak container

1. Keycloak được publish ra host port 8090 map vào container port 8080
2. Kiểm tra từ host
   curl http://127.0.0.1:8090

Phần 3 Cài Nginx reverse proxy

Bước 1 Cài Nginx

1. Cài Nginx trên VM
   sudo apt update
   sudo apt install nginx
2. Kiểm tra trạng thái
   systemctl status nginx
3. Kiểm tra Nginx lắng nghe port 80
   sudo ss -lntp | grep :80
4. Test nội bộ
   curl http://127.0.0.1

Bước 2 Reverse proxy cho Nextcloud HTTP

1. Tạo site config
   sudo nano /etc/nginx/sites-available/cloudnkd.km0.vn
2. Nội dung cấu hình tham khảo

server {
    listen 80;
    server_name cloudnkd.km0.vn;

    location / {
        proxy_pass http://127.0.0.1:8080;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

3. Enable site
   sudo ln -s /etc/nginx/sites-available/cloudnkd.km0.vn /etc/nginx/sites-enabled/
4. Kiểm tra cấu hình
   sudo nginx -t
5. Reload Nginx
   sudo systemctl reload nginx
6. Test từ Internet
   http://cloudnkd.km0.vn

Bước 3 Reverse proxy cho Keycloak HTTP

1. Tạo site config
   sudo nano /etc/nginx/sites-available/auth.cloudnkd.km0.vn
2. Nội dung cấu hình tham khảo

server {
    listen 80;
    server_name auth.cloudnkd.km0.vn;

    location / {
        proxy_pass http://127.0.0.1:8090;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

3. Enable site
   sudo ln -s /etc/nginx/sites-available/auth.cloudnkd.km0.vn /etc/nginx/sites-enabled/
4. Kiểm tra và reload
   sudo nginx -t
   sudo systemctl reload nginx
5. Test từ Internet
   http://auth.cloudnkd.km0.vn

Phần 4 Cấp HTTPS Let’s Encrypt

Vấn đề package certbot trong apt

Hệ thống gặp lỗi phụ thuộc do python3 quá mới, dẫn đến không thể cài certbot bằng apt. Giải pháp dùng certbot qua Snap để tránh phụ thuộc Python hệ thống.

Bước 1 Cài Snap certbot

1. Cài snapd nếu chưa có
   sudo apt install snapd
   sudo systemctl enable --now snapd
2. Cài core và certbot
   sudo snap install core
   sudo snap refresh core
   sudo snap install --classic certbot
3. Tạo symlink để gọi certbot tiện
   sudo ln -s /snap/bin/certbot /usr/bin/certbot
4. Kiểm tra phiên bản
   certbot --version

Bước 2 Cấp chứng chỉ cho Nextcloud

1. Đảm bảo HTTP truy cập được cloudnkd.km0.vn
2. Chạy
   sudo certbot --nginx -d cloudnkd.km0.vn
3. Khi được hỏi redirect từ HTTP sang HTTPS chọn Yes
4. Test
   https://cloudnkd.km0.vn

Bước 3 Cấp chứng chỉ cho Keycloak

1. Đảm bảo HTTP truy cập được auth.cloudnkd.km0.vn
2. Chạy
   sudo certbot --nginx -d auth.cloudnkd.km0.vn
3. Chọn redirect HTTP sang HTTPS
4. Test
   https://auth.cloudnkd.km0.vn

Bước 4 Kiểm tra auto renew

1. Test gia hạn giả lập
   sudo certbot renew --dry-run
2. Kiểm tra timer
   sudo systemctl list-timers | grep certbot

Phần 5 Cấu hình Nextcloud nhận biết HTTPS sau reverse proxy

Hiện tượng lỗi

Khi test SSO có thể gặp thông báo You must access Nextcloud with HTTPS to use OpenID Connect dù đang mở bằng https. Nguyên nhân là Nextcloud không tin proxy hoặc không nhận đúng X Forwarded Proto.

Bước 1 Sửa header proxy trong Nginx cho Nextcloud

Trong cấu hình Nextcloud, đảm bảo có header X Forwarded Proto. Khi chạy HTTPS, có thể set cứng https để chắc chắn.

Ví dụ đoạn location khi đã có HTTPS

location / {
    proxy_pass http://127.0.0.1:8080;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

Sau đó reload Nginx
sudo nginx -t
sudo systemctl reload nginx

Bước 2 Thiết lập trusted proxies và overwrite trong Nextcloud

Chạy các lệnh occ trong container Nextcloud

1. Thiết lập trusted_proxies
   docker exec -u www-data nextcloud_app php occ config:system:set trusted_proxies 0 --value=127.0.0.1
   docker exec -u www-data nextcloud_app php occ config:system:set trusted_proxies 1 --value=172.16.20.61
   docker exec -u www-data nextcloud_app php occ config:system:set trusted_proxies 2 --value=14.224.247.131

2. Thiết lập overwrite để Nextcloud luôn dùng https và đúng host
   docker exec -u www-data nextcloud_app php occ config:system:set overwriteprotocol --value=https
   docker exec -u www-data nextcloud_app php occ config:system:set overwritehost --value=cloudnkd.km0.vn
   docker exec -u www-data nextcloud_app php occ config:system:set overwrite.cli.url --value=https://cloudnkd.km0.vn

3. Restart container
   docker restart nextcloud_app

Bước 3 Xử lý trusted domain

Nếu gặp màn hình Access through untrusted domain, cần thêm domain vào trusted_domains.

Ví dụ
docker exec -u www-data nextcloud_app php occ config:system:set trusted_domains 3 --value=cloudnkd.km0.vn

Phần 6 Cấu hình Keycloak cho chạy sau reverse proxy và domain

Bước 1 Chỉnh docker compose của Keycloak

Mở file docker compose, ví dụ /opt/keycloak/docker-compose.yml

Cấu hình khuyến nghị

services:
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    container_name: keycloak
    restart: always
    command: start
    environment:
      KC_PROXY: edge
      KC_HOSTNAME: auth.cloudnkd.km0.vn
      KC_HOSTNAME_STRICT: "true"
      KC_HTTP_ENABLED: "true"
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: Admin@123456
    ports:
      "8090:8080"

Lưu ý

1. command start thay cho start-dev để phù hợp môi trường triển khai thật
2. Dùng KC_BOOTSTRAP_ADMIN_USERNAME và KC_BOOTSTRAP_ADMIN_PASSWORD theo chuẩn Keycloak mới

Bước 2 Restart Keycloak bằng compose

Chạy trong thư mục compose

docker compose down
docker compose up -d

Test

1. https://auth.cloudnkd.km0.vn
2. Discovery endpoint
   https://auth.cloudnkd.km0.vn/realms/master/.well-known/openid-configuration

Phần 7 Cấu hình Nextcloud đăng nhập bằng Keycloak OIDC

Bước 1 Bật app OpenID Connect Login trong Nextcloud

Trong Apps tìm OpenID Connect Login và enable, app id thường là user_oidc.

Có thể kiểm tra bằng occ
docker exec -u www-data nextcloud_app php occ app:list | grep oidc

Nếu chưa enable
docker exec -u www-data nextcloud_app php occ app:enable user_oidc

Lưu ý quan trọng

Không dùng app OpenID Connect SSO by Gluu vì app đó yêu cầu oxD và có thể lỗi tải gói từ GitHub.

Bước 2 Tạo client cho Nextcloud trong Keycloak

Trong Keycloak admin console

1. Realm: master hoặc realm bạn dùng
2. Clients tạo hoặc chọn client nextcloud
3. Thiết lập

Root URL
https://cloudnkd.km0.vn

Valid redirect URIs
https://cloudnkd.km0.vn/apps/user_oidc/code

Valid post logout redirect URIs
https://cloudnkd.km0.vn

Web origins
https://cloudnkd.km0.vn

4. Bật Client authentication để có client secret
5. Vào Credentials copy client secret

Bước 3 Đảm bảo scope và mapper email trong Keycloak

Nextcloud yêu cầu email claim để map user.

1. Default client scopes có openid profile email
2. Mapper email phải add vào ID token access token và userinfo

Bước 4 Cấu hình provider trong Nextcloud

Vào trang cấu hình
https://cloudnkd.km0.vn/settings/admin/user_oidc

Tạo provider ví dụ tên keycloak với các trường

1. Client ID: nextcloud
2. Client secret: giá trị copy từ Keycloak
3. Discovery endpoint
   https://auth.cloudnkd.km0.vn/realms/master/.well-known/openid-configuration
4. Scope
   openid profile email
5. User ID mapping
   preferred_username hoặc sub

Bước 5 Tạo user trong Keycloak để đăng nhập Nextcloud

Trong Keycloak Users tạo user ví dụ cuongnv

1. Username: cuongnv
2. Email: cuongnv@cloudnkd.km0.vn
3. Email verified: On
4. Enabled: On
5. Set password trong tab Credentials, Temporary off

Bước 6 Test đăng nhập SSO

1. Mở trình duyệt ẩn danh
2. Truy cập https://cloudnkd.km0.vn
3. Chọn Login với Keycloak
4. Đăng nhập bằng user cuongnv tại https://auth.cloudnkd.km0.vn
5. Sau đăng nhập, Nextcloud tự tạo user tương ứng và cho vào giao diện chính

Bước 7 Phân quyền admin trong Nextcloud cho user OIDC nếu cần quản trị

Nếu đăng nhập bằng cuongnv rồi vào trang /settings/admin/user_oidc bị Access forbidden, đó là bình thường vì user chưa là admin.

Để gán user cuongnv vào nhóm admin của Nextcloud

docker exec -u www-data nextcloud_app php occ user:add-group cuongnv admin

Logout và login lại để quyền có hiệu lực.

Phần 8 Checklist kiểm tra nhanh

1. DNS
   cloudnkd.km0.vn và auth.cloudnkd.km0.vn trỏ 14.224.247.131
2. NAT inbound
   Port 80 và 443 forward về VM chạy Nginx
3. Nginx
   systemctl status nginx active
4. HTTPS
   https cho cả 2 domain hợp lệ
5. Keycloak discovery
   Mở https://auth.cloudnkd.km0.vn/realms/master/.well-known/openid-configuration ra JSON
6. Nextcloud proxy trust
   overwriteprotocol https, trusted_proxies đúng
7. Nextcloud OIDC
   Provider dùng discovery https, scope có email
8. Keycloak user
   Có email và email verified, có password
9. Đăng nhập
   Login từ Nextcloud redirect sang Keycloak và quay lại thành công

Phần 9 Lệnh hữu ích khi debug

1. Xem log Nextcloud realtime
   docker exec -u www-data nextcloud_app php occ log:watch
2. Xem cấu hình overwrite của Nextcloud
   docker exec -u www-data nextcloud_app php occ config:list system | grep overwrite
3. Test endpoint từ VM
   curl -I https://cloudnkd.km0.vn
   curl -I https://auth.cloudnkd.km0.vn
4. Kiểm tra port listen
   sudo ss -lntp | grep :80
   sudo ss -lntp | grep :443
5. Kiểm tra certbot
   certbot --version
   sudo certbot certificates
   sudo certbot renew --dry-run
