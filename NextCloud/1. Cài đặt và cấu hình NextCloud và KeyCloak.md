# B√°o c√°o c√†i ƒë·∫∑t v√† c·∫•u h√¨nh Nextcloud, Keycloak (OIDC)

## 1. M·ª•c ti√™u

Thi·∫øt l·∫≠p h·ªá th·ªëng Nextcloud ch·∫°y b·∫±ng Docker, x√°c th·ª±c ng∆∞·ªùi d√πng th√¥ng
qua Keycloak s·ª≠ d·ª•ng chu·∫©n OpenID Connect (OIDC). Ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p
Nextcloud s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng sang Keycloak ƒë·ªÉ x√°c th·ª±c t·∫≠p trung.

------------------------------------------------------------------------

## 2. Ki·∫øn tr√∫c h·ªá th·ªëng

-   Ubuntu Server (VM)
-   Docker & Docker Compose
-   Nextcloud (container)
-   MariaDB/MySQL (container)
-   Keycloak (container)
-   Docker network d√πng chung: `sso-net`

Lu·ªìng ƒëƒÉng nh·∫≠p: Ng∆∞·ªùi d√πng ‚Üí Nextcloud ‚Üí Keycloak ‚Üí Nextcloud

------------------------------------------------------------------------

## 3. C√†i ƒë·∫∑t Docker tr√™n Ubuntu

``` bash
sudo apt update
sudo apt install -y docker.io docker-compose-plugin
sudo systemctl enable --now docker
sudo usermod -aG docker $USER
newgrp docker
```

Ki·ªÉm tra:

``` bash
docker --version
docker compose version
```

------------------------------------------------------------------------

## 4. Tri·ªÉn khai Nextcloud b·∫±ng Docker

### docker-compose.yml

``` yaml
version: "3.8"

services:
  db:
    image: mariadb:10.11
    container_name: nextcloud_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloudpass
    volumes:
      - db:/var/lib/mysql

  app:
    image: nextcloud:29
    container_name: nextcloud_app
    restart: always
    ports:
      - "8080:80"
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloudpass
    volumes:
      - nextcloud:/var/www/html
    depends_on:
      - db

volumes:
  db:
  nextcloud:
```

Ch·∫°y:

``` bash
docker compose up -d
```

Truy c·∫≠p: http://IP:8080

------------------------------------------------------------------------

## 5. Tri·ªÉn khai Keycloak b·∫±ng Docker

### docker-compose.yml

``` yaml
version: "3.8"

services:
  keycloak:
    image: quay.io/keycloak/keycloak:24
    container_name: keycloak
    command: start-dev
    ports:
      - "8090:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
```

Ch·∫°y:

``` bash
docker compose up -d
```

Truy c·∫≠p: http://IP:8090/admin

------------------------------------------------------------------------

## 6. K·∫øt n·ªëi Nextcloud v√† Keycloak v√†o c√πng Docker network

``` bash
docker network create sso-net
docker network connect sso-net nextcloud_app
docker network connect sso-net keycloak
docker restart nextcloud_app keycloak
```

------------------------------------------------------------------------

## 7. Fix l·ªói Discovery endpoint ( quan tr·ªçng )
### B·∫°n c√≥ setup nh∆∞ sau:

‚Ä¢ Nextcloud ch·∫°y Docker container
‚Ä¢ Keycloak ch·∫°y Docker container
‚Ä¢ Discovery endpoint truy c·∫≠p ƒë∆∞·ª£c t·ª´ host
‚Ä¢ ‚ùå Nh∆∞ng Nextcloud ch·∫∑n request HTTP n·ªôi b·ªô (local/private IP)

üëâ ƒê√¢y l√† c∆° ch·∫ø b·∫£o m·∫≠t m·∫∑c ƒë·ªãnh c·ªßa Nextcloud
N√≥ KH√îNG cho g·ªçi OpenID Discovery t·ªõi IP LAN / HTTP, n√™n UI b√°o:

discovery endpoint is not reachable

Cho d√π network OK.

#### B1. Cho ph√©p Nextcloud g·ªçi endpoint n·ªôi b·ªô

Ch·∫°y l·ªánh n√†y tr√™n host (r·∫•t quan tr·ªçng):
```yaml
docker exec -u www-data nextcloud_app php occ config:system:set allow_local_remote_servers --value=true
```
Ki·ªÉm tra l·∫°i:
```yaml
docker exec -u www-data nextcloud_app php occ config:system:get allow_local_remote_servers
```

Ph·∫£i ra:
```yaml
true
```

#### B2. Restart container Nextcloud
```yaml
docker restart nextcloud_app
```








