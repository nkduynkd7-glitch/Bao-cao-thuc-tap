
# BÁO CÁO TRIỂN KHAI HỆ THỐNG MAILCOW TRÊN DOCKER

## 1. Thông tin tổng quan

- Hệ điều hành: Ubuntu Server 22.04 LTS  
- IP nội bộ server: 172.16.20.66  
- IP public: 210.245.58.110  
- Domain mail: mailduynk.km0.vn  
- Nền tảng mail: Mailcow Dockerized  
- HTTPS certificate: Let's Encrypt (Certbot)  
- Mô hình triển khai: On premise sau NAT  

---

## 2. Cài đặt Docker và Docker Compose

### 2.1 Cập nhật hệ thống

```yaml
sudo apt update
sudo apt upgrade -y
```

### 2.2 Cài các gói phụ trợ

```yaml
sudo apt install -y ca-certificates curl gnupg lsb-release jq
```

### 2.3 Cài Docker Engine

```yaml
curl -fsSL https://get.docker.com | sudo sh
sudo systemctl enable docker
sudo systemctl start docker
```

Kiểm tra:

```yaml
docker --version
```

### 2.4 Cài Docker Compose plugin

```yaml
docker compose version
```

---

## 3. Cài đặt Mailcow

### 3.1 Clone Mailcow

```yaml
cd /opt
git clone https://github.com/mailcow/mailcow-dockerized.git
cd mailcow-dockerized
```

### 3.2 Generate cấu hình

```yaml
sudo ./generate_config.sh
```

Khai báo:
- Hostname: mailduynk.km0.vn
- Timezone: Asia/Ho_Chi_Minh

### 3.3 Cấu hình mailcow.conf

```ini
MAILCOW_HOSTNAME=mailduynk.km0.vn
SKIP_LETS_ENCRYPT=y
ENABLE_SSL_SNI=y
IPV4_NETWORK=172.16.20.0
IPV4_NETMASK=24
```

### 3.4 Khởi động Mailcow

```yaml
docker compose up -d
```

---

## 4. Mapping domain mail

### 4.1 DNS public

```dns
mailduynk.km0.vn   A   210.245.58.110
km0.vn             MX  10 mailduynk.km0.vn
km0.vn TXT "v=spf1 ip4:210.245.58.110 ~all"
```

### 4.2 Kiểm tra DNS

```yaml
dig mailduynk.km0.vn @8.8.8.8 +short
```

---

## 5. Xin HTTPS certificate bằng Certbot

### 5.1 Dừng nginx Mailcow

```yaml
docker stop mailcowdockerized-nginx-mailcow-1
```

### 5.2 Xin certificate

```yaml
 certbot certonly \
  --manual \
  --preferred-challenges dns \
  -d mailduynk.km0.vn
```
<img width="768" height="408" alt="image" src="https://github.com/user-attachments/assets/0647af27-c634-4627-9d8f-e08fa31aa7e3" />

Chờ đăng ký, sau khi đăng ký xong check lại trên Putty khác

```yaml
dig TXT _acme-challenge.mailduynk.km0.vn +short
```
<img width="570" height="56" alt="image" src="https://github.com/user-attachments/assets/59a7c3e2-1370-4b51-bc1a-907ba4c52dbe" />

Ra đúng mã sau đó ấn enter bên Putty đầu tiên

<img width="712" height="563" alt="image" src="https://github.com/user-attachments/assets/f4d3ee95-0411-4b94-9cec-d6c0a867031c" />


### 5.3 Start lại nginx Mailcow

```yaml
docker start mailcowdockerized-nginx-mailcow-1
```

---

## 6. Gắn certificate vào Mailcow

```yaml
cp /etc/letsencrypt/live/mailduynk.km0.vn/fullchain.pem \
   /opt/mailcow-dockerized/data/assets/ssl/cert.pem

cp /etc/letsencrypt/live/mailduynk.km0.vn/privkey.pem \
   /opt/mailcow-dockerized/data/assets/ssl/key.pem
```

---

## 7. Khởi động lại và check
```yaml
cd /opt/mailcow-dockerized
docker compose restart
```

```yaml
 curl -Iv https://mailduynk.km0.vn
```
Trả ra HTTP/2 200
là hoàn thành
