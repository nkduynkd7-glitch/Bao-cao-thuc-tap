# BÁO CÁO KỸ THUẬT: TRIỂN KHAI HỆ THỐNG LOAD BALANCING & HIGH AVAILABILITY (HA)

## 1. Tổng quan mô hình
Hệ thống được thiết kế để đảm bảo tính sẵn sàng cao (High Availability) cho dịch vụ Web, sử dụng **Keepalived** để quản lý IP ảo và **HAProxy** để điều phối lưu lượng.

### Thông số cấu hình:
* **Virtual IP (VIP):** `172.16.20.100`
* **Node 1 (VM1):** `172.16.20.70` (Dịch vụ: Apache @8081)
* **Node 2 (VM2):** `172.16.20.71` (Dịch vụ: Apache @8081 + HAProxy @80)

---

## 2. Các bước triển khai chi tiết

### Bước 1: Khởi tạo dịch vụ Web (Apache)
Thực hiện trên cả hai máy để chuẩn bị backend cho HAProxy.

```yaml
# Cài đặt Apache
sudo apt update && sudo apt install -y apache2

# Đổi cổng lắng nghe sang 8081 để tránh xung đột cổng 80
sudo sed -i 's/Listen 80/Listen 8081/' /etc/apache2/ports.conf
sudo sed -i 's/<VirtualHost \*:80>/<VirtualHost *:8081>/' /etc/apache2/sites-available/000-default.conf

# Tạo nội dung trang chủ phân biệt giữa 2 máy
# Trên VM1:
echo "<h1>Day la VM1 - 172.16.20.70</h1>" | sudo tee /var/www/html/index.html
# Trên VM2:
echo "<h1>Day la VM2 - 172.16.20.71</h1>" | sudo tee /var/www/html/index.html

# Khởi động lại dịch vụ
sudo systemctl restart apache2
```

### Bước 2: Cấu hình High Availability (Keepalived)
Mục tiêu: Đảm bảo IP ảo 172.16.20.100 luôn tồn tại ngay cả khi một Node gặp sự cố.

- Tại VM1 (MASTER):

```yaml
# File: /etc/keepalived/keepalived.conf
vrrp_instance VI_1 {
    state MASTER
    interface eth0          # Kiểm tra bằng lệnh 'ip a'
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1234
    }
    virtual_ipaddress {
        172.16.20.100
    }
}
```

- Tại VM2
Cấu hình tương tự nhưng sửa state BACKUP và priority 90.
```yaml
vrrp_instance VI_1 {
    state BACKUP
    interface eth0           # Thay bằng tên card mạng của bạn
    virtual_router_id 51
    priority 90             # VM2 ưu tiên thấp hơn
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1234
    }
    virtual_ipaddress {
        172.16.20.100        # IP ảo dùng chung
    }
}
```

### Bước 3: Cấu hình Load Balancing (HAProxy)
Thiết lập HAProxy để nhận yêu cầu tại cổng 80 và chuyển tiếp tới các Backend.
#### Thiết lập ở cả 2 VM
```yaml
# File: /etc/haproxy/haproxy.cfg

frontend http_front
    bind *:80
    default_backend web_servers

backend web_servers
    balance roundrobin
    option httpchk GET /
    # Sử dụng IP nghiệp vụ thật để kiểm tra
    server node1 172.16.20.70:8081 check 
    server node2 172.16.20.71:8081 check

listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats auth admin:password123
```

### 4. Kịch bản kiểm thử & Kết quả
Check trên đường dẫn **http://172.16.20.100:8080/stats**

- user: admin
- pass: password123

<img width="956" height="553" alt="image" src="https://github.com/user-attachments/assets/010b353e-3316-4e5e-9169-d4df05bb129a" />


#### 4.1. Kiểm tra Cân bằng tải
Thao tác: Truy cập http://172.16.20.100 (VIP).

Kết quả: Nhấn F5 liên tục, trang web hiển thị luân phiên giữa VM1 và VM2.

<img width="576" height="217" alt="image" src="https://github.com/user-attachments/assets/7dc74e42-4c1c-4a06-a2b6-aa26bc9606f9" />

<img width="470" height="200" alt="image" src="https://github.com/user-attachments/assets/9685843f-cd8c-4d5c-ac9b-7855b092f134" />



#### 4.2. Kiểm tra tính sẵn sàng (Failover)
Thao tác: Chạy **sudo systemctl stop keepalived** trên VM1.

Kết quả: IP .100 tự động xuất hiện trên VM2. Người dùng vẫn truy cập được dịch vụ bình thường.

#### 4.3. Kiểm tra chịu lỗi dịch vụ (Service Failover)
Thao tác: Chạy **sudo systemctl stop apache2** trên VM1.

<img width="957" height="544" alt="image" src="https://github.com/user-attachments/assets/1ac01527-ae17-43b4-8af3-39d50f83b059" />

Kết quả: HAProxy trên VM2 phát hiện Node1 chết (chuyển màu đỏ trên Stats). Toàn bộ yêu cầu chỉ còn gửi về VM2.

<img width="391" height="128" alt="image" src="https://github.com/user-attachments/assets/d6370713-30ff-4c62-8b2c-c1f1d3478a8e" />

Khởi động lại VM1
```yaml
sudo systemctl restart apache2
```

<img width="957" height="529" alt="image" src="https://github.com/user-attachments/assets/5cd5dfce-7073-44fa-ba0d-4373227e5488" />


### 5. Tổng kết
Hệ thống đã vận hành hoàn chỉnh trên luồng IP nghiệp vụ thực tế. Đảm bảo được cả hai yếu tố:

- Load Balancing: Chia đều tải cho các server backend.

- High Availability: Tự động khôi phục và chuyển hướng khi có sự cố mạng hoặc dịch vụ.
